{{> _head}}
<main class="container-gradient">
  <div class="p-4 mx-auto w-2/5 h-full flex flex-col justify-center items-center gap-10">
    <form class="flex jusitfy-left flex-col w-2/3 px-10 py-20 rounded-md bg-white shadow-md" id="confirm-code-form"
      data-testid="confirm-code-form" method="post" action="/forms/confirm-code">
      <h1 class="text-xl">Confirmar cadastro</h1>

      <p class="my-5">
        Por favor, digite seu c贸digo que te enviamos por e-mail.
      </p>

      <div class="input-control">
        <label for="code" class="input-label">C贸digo</label>

        <input class="input" id="code" type="text" name="code" data-testid="code" />

        <ul class="input-errors" id="code-error-messages" data-testid="code-error-messages"></ul>
      </div>


      <input type="hidden" name="email" data-testid="email" value="{{email}}" />

      <div id="buttons" class="flex my-2 justify-between items-center">
        <button class="primary-button" type="submit" data-testid="confirm-code-submit">
          Confirmar
        </button>
      </div>
      <!-- TODO: add code counter -->
    </form>
  </div>
</main>

<script>
  const buttons_div = document.getElementById('buttons');

  const expired_at = new Date();
  expired_at.setMinutes(expired_at.getMinutes() + 1);

  const counter = document.createElement('div');
  counter.setAttribute('data-testid', 'confirm-code-counter');
  counter.classList.add('text-sm', 'text-gray-500');
  counter.innerHTML = 'O c贸digo expira em <b>5:00</b>';

  const resent_button = document.createElement('buttton');
  resent_button.setAttribute('data-testid', 'confirm-code-resent-button');
  resent_button.setAttribute('type', 'button');
  resent_button.classList.add('primary-outline-button');
  resent_button.addEventListener('click', async (e) => {
    console.log(e);
  });
  resent_button.textContent = 'Reenviar';

  buttons_div.insertBefore(counter, buttons_div.firstChild);

  const formatter = new Intl.DateTimeFormat('pt-BR', { second: 'numeric', minute: 'numeric' });

  const interval_id = setInterval(() => {
    const current = new Date();
    if (expired_at < current && buttons_div.contains(counter)) {
      buttons_div.removeChild(counter);
      buttons_div.insertBefore(resent_button, buttons_div.firstChild);
      clearInterval(interval_id);
      return;
    }

    const date_time_remaining = expired_at.getTime() - current.getTime();

    counter.innerHTML = `O c贸digo expira em <b>${formatter.format(date_time_remaining)}</b>`;
  }, 1000);

  new Form(
    document.getElementById('confirm-code-form'),
    [
      {
        input_element: document.getElementById('code'),
        error_message_element: document.getElementById('code-error-messages'),
        rules: ['required', 'min:4']
      },
    ]
  ).init();
</script>
{{> _footer}}